---

- name: Enable strong dotnet crypto
  win_regedit:
    key: "{{ item }}"
    value: SchUseStrongCrypto
    datatype: dword
    data: 1
  with_items:
    - "HKLM:\\SOFTWARE\\Microsoft\\.NetFramework\\v4.0.30319"
    - "HKLM:\\SOFTWARE\\Wow6432Node\\Microsoft\\.NetFramework\\v4.0.30319"

- name: Check installed providers
  win_shell: Get-PackageProvider
  register: providers
  changed_when: false

# This line will fail in CCPaaS if NuGet is not already installed!
- name: Install NuGet Provider
  win_shell: |
    Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
  when: providers.stdout is not search("NuGet")

# Note the modified links below. 
# When this runs inside CCPaaS, it will pull from our S3 bucket instead of from the internet
# Original link: https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1
- name: Install Atomic Red Team
  win_shell: |
    Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Internet Explorer\Main" -Name "DisableFirstRunCustomize" -Value 2
    IEX (IWR http://10.0.2.2/sar/www/raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1)
    Install-AtomicRedTeam
    IEX (IWR 'http://10.0.2.2/sar/www/raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicsfolder.ps1' -UseBasicParsing)
    Install-AtomicsFolder
  when: art_run_techniques != ""

- set_fact:
    techniques: "{{ art_run_techniques.split(',') }}"

- include_tasks: "run_art_test.yml"
  with_items: "{{ techniques }}"